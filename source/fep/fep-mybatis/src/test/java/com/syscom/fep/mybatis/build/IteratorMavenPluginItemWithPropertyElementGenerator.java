package com.syscom.fep.mybatis.build;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Paths;
import java.util.Arrays;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;
import org.junit.jupiter.api.Test;
import org.springframework.core.io.support.PathMatchingResourcePatternResolver;
import org.springframework.util.ResourceUtils;

import com.syscom.fep.frmcommon.log.LogHelper;

public class IteratorMavenPluginItemWithPropertyElementGenerator {
    @Test
    public void generate() {
        LogHelper logger = new LogHelper();
        try {
            StringBuilder tableNames = new StringBuilder("assembly-prop-mybatis-tables=\\\r\n");
            StringBuilder classpath = new StringBuilder("assembly-prop-mybatis-classpath=\\\r\n");
            org.springframework.core.io.Resource[] resources =
                    new PathMatchingResourcePatternResolver().getResources(StringUtils.join(
                            ResourceUtils.CLASSPATH_URL_PREFIX, "com/syscom/fep/mybatis/model/*.class"));
            for (org.springframework.core.io.Resource resource : resources) {
                String fileName = FilenameUtils.getBaseName(resource.getFilename());
                logger.info("start with ", fileName);
                tableNames.append(fileName).append(",\\\r\n");
                classpath.append("lib/fep-mybatis-").append(fileName).append(".jar \\\r\n");
            }
            tableNames.delete(tableNames.length() - 4, tableNames.length());
            classpath.delete(classpath.length() - 4, classpath.length());

            logger.info(tableNames.toString());
            logger.info(classpath.toString());
            FileUtils.write(new File(Paths.get("../fep-config/src/main/assembly/fep-mybatis/assembly-mybatis-prop.properties").toString()),
                    StringUtils.join(
                            Arrays.asList(
                                    "#You can modify this file, or generated by UT program \"com.syscom.fep.mybatis.build.IteratorMavenPluginItemWithPropertyElementGenerator\"",
                                    tableNames.toString(),
                                    classpath.toString()),
                            "\r\n"),
                    StandardCharsets.UTF_8, false);
        } catch (FileNotFoundException e) {
            logger.error(e, e.getMessage());
        } catch (IOException e) {
            logger.error(e, e.getMessage());
        }
    }
}