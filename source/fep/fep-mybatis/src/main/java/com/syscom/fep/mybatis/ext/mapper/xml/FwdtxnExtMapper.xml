<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.syscom.fep.mybatis.ext.mapper.FwdtxnExtMapper">


  <resultMap id="BaseResultMap" type="com.syscom.fep.mybatis.ext.mapper.FwdtxnExtMapper">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <constructor>
      <idArg column="FWDTXN_TX_ID" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="FWDTXN_PCODE" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="FWDTXN_CHANNEL_S" javaType="java.lang.String" jdbcType="VARCHAR" />
      <arg column="FWDTXN_TROUT_ACTNO" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="FWDTXN_TRIN_BKNO" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="FWDTXN_TRIN_ACTNO" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="FWDTXN_TX_AMT" javaType="java.math.BigDecimal" jdbcType="DECIMAL" />
      <arg column="FWDRST_RUN_NO" javaType="java.lang.String" jdbcType="VARCHAR" />
      <arg column="FWDRST_EJFNO" javaType="java.lang.String" jdbcType="VARCHAR" />
      <arg column="FWDRST_TXRUST" javaType="java.lang.String" jdbcType="VARCHAR" />
      <arg column="FWDRST_REPLY_CODE" javaType="java.lang.String" jdbcType="VARCHAR" />
      <arg column="FWDRST_ERR_MSG" javaType="java.lang.String" jdbcType="VARCHAR" />
      <arg column="FWDTXN_RERUN_FG" javaType="java.lang.String" jdbcType="VARCHAR" />
    </constructor>
  </resultMap>

  <select id="getFwdtxn" parameterType="map" resultType="java.util.HashMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    SELECT FWDTXN.*,
    FWDRST.FWDRST_TX_ID,
    FWDRST.FWDRST_TX_DATE,
    FWDRST.FWDRST_RUN_NO,
    FWDRST.FWDRST_TXRUST,
    FWDRST.FWDRST_EJFNO,
    FWDRST.FWDRST_REPLY_CODE,
    FWDRST.FWDRST_CBS_RRN,
    FWDRST.FWDRST_CBS_TX_CODE,
    FWDRST.FWDRST_ERR_MSG,SYSSTAT.SYSSTAT_HBKNO AS SYSSTAT_HBKNO  FROM SYSSTAT, FWDTXN
    left join FWDRST
    ON FWDTXN_TX_DATE = FWDRST_TX_DATE
    AND FWDTXN_TX_ID = FWDRST_TX_ID
    AND FWDTXN_RUN_NO = FWDRST_RUN_NO
    where FWDTXN_REPLY_CODE NOT IN ('0000','    ') AND FWDTXN_RERUN_FG != 'T'
    <if test="fwdtxnTxDate != null">
      AND FWDTXN_TX_DATE = #{fwdtxnTxDate,jdbcType=CHAR}
    </if>
    <if test="fwdtxnTroutActno != null">
      AND FWDTXN_TROUT_ACTNO = #{fwdtxnTroutActno,jdbcType=CHAR}
    </if>
    <if test="fwdtxnTrinBkno != null">
      AND FWDTXN_TRIN_BKNO = #{fwdtxnTrinBkno,jdbcType=CHAR}
    </if>
    <if test="fwdtxnTrinActno != null">
      AND FWDTXN_TRIN_ACTNO = #{fwdtxnTrinActno,jdbcType=CHAR}
    </if>
    <if test="fwdtxnTxAmt != null">
      AND FWDTXN_TX_AMT = #{fwdtxnTxAmt,jdbcType=DECIMAL}
    </if>
  </select>

  <select id="getFailTimes" parameterType="map" resultType="java.util.HashMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    SELECT
    SUM(
    CASE
    WHEN
    FWDTXN_REPLY_CODE != '    '
    AND FWDTXN_REPLY_CODE != '0000' THEN
    1 ELSE 0
    END) AS FAILTIMES,
    SUM(CASE
    WHEN FWDTXN_REPLY_CODE != '    '
    AND FWDTXN_REPLY_CODE != '0000'
    AND LENGTH( TRIM( FWDTXN_REPLY_CODE ) ) >= 2
    AND SUBSTR( FWDTXN_REPLY_CODE, 1, 2 ) = 'EF' THEN
    1 ELSE 0
    END) AS SYSFAILTIMES,
    SUM(CASE
    WHEN FWDTXN_REPLY_CODE != '    '
    AND FWDTXN_REPLY_CODE != '0000'
    AND LENGTH( TRIM( FWDTXN_REPLY_CODE ) ) >= 2
    AND SUBSTR( FWDTXN_REPLY_CODE, 1, 2 ) = 'EX' THEN
    1 ELSE 0
    END) AS OTHERFAILTIMES,
    SUM(CASE
    WHEN FWDTXN_REPLY_CODE != '    '
    AND FWDTXN_REPLY_CODE != '0000'
    AND LENGTH( TRIM( FWDTXN_REPLY_CODE ) ) >= 2
    AND SUBSTR( FWDTXN_REPLY_CODE, 1, 2 ) != 'EF'
    AND SUBSTR( FWDTXN_REPLY_CODE, 1, 2 ) != 'EX' THEN
    1 ELSE 0
    END) AS CUSTFAILTIMES
    FROM SYSSTAT, FWDTXN
    left join FWDRST
    ON FWDTXN_TX_DATE = FWDRST_TX_DATE
    AND FWDTXN_TX_ID = FWDRST_TX_ID
    AND FWDTXN_RUN_NO = FWDRST_RUN_NO
    where FWDTXN_REPLY_CODE NOT IN ('0000','    ') AND FWDTXN_RERUN_FG != 'T'
    <if test="fwdtxnTxDate != null">
      AND FWDTXN_TX_DATE = #{fwdtxnTxDate,jdbcType=CHAR}
    </if>
    <if test="fwdtxnTroutActno != null">
      AND FWDTXN_TROUT_ACTNO = #{fwdtxnTroutActno,jdbcType=CHAR}
    </if>
    <if test="fwdtxnTrinBkno != null">
      AND FWDTXN_TRIN_BKNO = #{fwdtxnTrinBkno,jdbcType=CHAR}
    </if>
    <if test="fwdtxnTrinActno != null">
      AND FWDTXN_TRIN_ACTNO = #{fwdtxnTrinActno,jdbcType=CHAR}
    </if>
    <if test="fwdtxnTxAmt != null">
      AND FWDTXN_TX_AMT = #{fwdtxnTxAmt,jdbcType=DECIMAL}
    </if>
  </select>
    <select id="getFWDTXNByTSBDYFISC" parameterType="map" resultType="java.util.HashMap">
      SELECT FWDTXN_CHANNEL_S,FWDTXN_TX_DATE,FWDTXN_TX_ID,FWDTXN_PCODE,
             FWDTXN_TROUT_ACTNO,FWDTXN_TRIN_BKNO,FWDTXN_TRIN_ACTNO,FWDTXN_TX_AMT,
             FWDTXN_REPLY_CODE,FWDRST_TX_DATE,FWDRST_TX_ID,FWDRST_RUN_NO,
             FWDRST_EJFNO,FWDRST_TXRUST,FWDRST_REPLY_CODE,FWDRST_ERR_MSG,FWDTXN_RERUN_FG
      FROM FWDTXN LEFT JOIN FWDRST ON FWDTXN_TX_DATE = FWDRST_TX_DATE AND
      FWDTXN_TX_ID = FWDRST_TX_ID AND FWDTXN_RUN_NO = FWDRST_RUN_NO
      <where>
        <if test='selectValue != "" and selectValue == "1"'>
          AND FWDTXN_REPLY_CODE IS NOT NULL
          AND FWDTXN_REPLY_CODE !='0000'
          AND FWDTXN_REPLY_CODE !='    '
        </if>
        <if test='selectValue != "" and selectValue == "2"'>
        AND FWDTXN_TX_ID = #{fwdtxnTxId,jdbcType=CHAR}
        </if>
        <if test='selectValue != "" and selectValue == "3"'>
        AND FWDTXN_RERUN_FG = 'Y'
        </if>
        <!-- 通路別 -->
        <if test="channel != ''">
             AND FWDTXN_CHANNEL_S = #{channel,jdbcType=VARCHAR}
         </if>
         <if test="fwdtxnTroutActno != ''">
             AND FWDTXN_TROUT_ACTNO = #{fwdtxnTroutActno,jdbcType=VARCHAR}
         </if>
         <if test="fwdtxnTrinBkno != ''">
             AND FWDTXN_TRIN_BKNO = #{fwdtxnTrinBkno,jdbcType=VARCHAR}
         </if>
         <if test="fwdtxnTrinActno != ''">
             AND FWDTXN_TRIN_ACTNO = #{fwdtxnTrinActno,jdbcType=VARCHAR}
         </if>
         <if test="fwdtxnTxAmt != ''">
             AND FWDTXN_TX_AMT = #{fwdtxnTxAmt,jdbcType=VARCHAR}
         </if>
        <!--原來的程式 mSQL.Append(" LEFT(FWDTXN_REPLY_CODE,2)='EF' AND ")-->
         <if test="sysFail != '' and sysFail == 1">
             AND  FWDTXN_REPLY_CODE LIKE 'EF%'
         </if>
         <if test="fwdrstTxDate != ''">
             AND  FWDTXN_TX_DATE = #{fwdrstTxDate,jdbcType=VARCHAR}
         </if>
      </where>
      ORDER BY FWDTXN_TX_DATE, FWDTXN_TX_ID, FWDRST_RUN_NO
    </select>
  <select id="getSummary" resultType="com.syscom.fep.mybatis.ext.model.FwdtxnExt">
    SELECT FWDTXN_CHANNEL_S,FWDTXN_TX_DATE,FWDTXN_TX_ID,FWDTXN_PCODE,
    FWDTXN_TROUT_ACTNO,FWDTXN_TRIN_BKNO,FWDTXN_TRIN_ACTNO,FWDTXN_TX_AMT,
    FWDTXN_REPLY_CODE,FWDRST_TX_DATE,FWDRST_TX_ID,FWDRST_RUN_NO,
    FWDRST_EJFNO,FWDRST_TXRUST,FWDRST_REPLY_CODE,FWDRST_ERR_MSG,FWDTXN_RERUN_FG
    FROM FWDTXN LEFT JOIN FWDRST ON FWDTXN_TX_DATE = FWDRST_TX_DATE AND
    FWDTXN_TX_ID = FWDRST_TX_ID AND FWDTXN_RUN_NO = FWDRST_RUN_NO
    <where>
      <if test='selectValue != "" and selectValue == "1"'>
        AND FWDTXN_REPLY_CODE IS NOT NULL
        AND FWDTXN_REPLY_CODE !='0000'
        AND FWDTXN_REPLY_CODE !='    '
      </if>
      <if test='selectValue != "" and selectValue == "2"'>
        AND FWDTXN_TX_ID = #{fwdtxnTxId,jdbcType=CHAR}
      </if>
      <if test='selectValue != "" and selectValue == "3"'>
        AND FWDTXN_RERUN_FG = 'Y'
      </if>
      <!-- 通路別 -->
      <if test="channel != ''">
        AND FWDTXN_CHANNEL_S = #{channel,jdbcType=VARCHAR}
      </if>
      <if test="fwdtxnTroutActno != ''">
        AND FWDTXN_TROUT_ACTNO = #{fwdtxnTroutActno,jdbcType=VARCHAR}
      </if>
      <if test="fwdtxnTrinBkno != ''">
        AND FWDTXN_TRIN_BKNO = #{fwdtxnTrinBkno,jdbcType=VARCHAR}
      </if>
      <if test="fwdtxnTrinActno != ''">
        AND FWDTXN_TRIN_ACTNO = #{fwdtxnTrinActno,jdbcType=VARCHAR}
      </if>
      <if test="fwdtxnTxAmt != ''">
        AND FWDTXN_TX_AMT = #{fwdtxnTxAmt,jdbcType=VARCHAR}
      </if>
      <!--原來的程式 mSQL.Append(" LEFT(FWDTXN_REPLY_CODE,2)='EF' AND ")-->
      <if test="sysFail != '' and sysFail == 1">
        AND  FWDTXN_REPLY_CODE LIKE 'EF%'
      </if>
      <if test="fwdrstTxDate != ''">
        AND  FWDTXN_TX_DATE = #{fwdrstTxDate,jdbcType=VARCHAR}
      </if>
    </where>
    ORDER BY FWDTXN_TX_DATE, FWDTXN_TX_ID, FWDRST_RUN_NO
  </select>
  <update id="lockFWDTXN" parameterType="com.syscom.fep.mybatis.model.Fwdtxn">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update FWDTXN
    SET FWDTXN_RERUN_FG = 'T'
    where FWDTXN_RERUN_FG != 'T'
    and FWDTXN_TX_DATE = #{fwdtxnTxDate,jdbcType=CHAR}
    and FWDTXN_TX_ID = #{fwdtxnTxId,jdbcType=CHAR}
    and FWDTXN_REPLY_CODE NOT IN ('0000','    ')
  </update>
</mapper>