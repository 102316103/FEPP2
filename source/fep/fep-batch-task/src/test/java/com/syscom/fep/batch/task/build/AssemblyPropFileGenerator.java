package com.syscom.fep.batch.task.build;

import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.StringUtils;
import org.junit.jupiter.api.Test;

import com.syscom.fep.common.log.LogHelperFactory;
import com.syscom.fep.frmcommon.log.LogHelper;
import com.syscom.fep.frmcommon.util.CleanPathUtil;

public class AssemblyPropFileGenerator {
    private static final LogHelper UnitTestLogger = LogHelperFactory.getUnitTestLogger();
    private static final List<String> excludes = Arrays.asList();

    @Test
    public void generate() {
        String base = AssemblyPropFileGenerator.class.getClassLoader().getResource(".").getPath();
        File target = new File(CleanPathUtil.cleanString(base)).getParentFile();
        File taskDirFile = new File(target, CleanPathUtil.cleanString("classes/com/syscom/fep/batch/task/"));
        List<File> list = listFiles(taskDirFile);
        StringBuilder sb = new StringBuilder("assembly-prop-batch-tasks=\\\r\n");
        for (File file : list) {
            sb.append(FilenameUtils.getBaseName(file.getPath())).append(",\\\r\n");
        }
        sb.delete(sb.length() - 4, sb.length());
        UnitTestLogger.info(sb.toString());
        try {
            FileUtils.write(new File(Paths.get("../fep-config/src/main/assembly/fep-batch-task/assembly-batch-task-prop.properties").toString()),
                    StringUtils.join(
                            Arrays.asList(
                                    "#You can modify this file, or generated by UT program \"com.syscom.fep.batch.task.AssemblyPropFileGenerator\"",
                                    sb.toString()),
                            "\r\n"),
                    StandardCharsets.UTF_8, false);
        } catch (IOException e) {
            UnitTestLogger.warn(e, e.getMessage());
        }
    }

    private List<File> listFiles(File file) {
        List<File> result = new ArrayList<>();
        File[] files = file.listFiles();
        if (ArrayUtils.isNotEmpty(files)) {
            for (File child : files) {
                if (excludes.stream().filter(t -> child.getName().startsWith(t)).findFirst().orElse(null) != null ||
                        child.getName().indexOf("$") > 0) {
                    continue;
                }
                result.addAll(listFiles(child));
            }
            return result;
        } else {
            return Arrays.asList(file);
        }
    }
}
