package com.syscom.fep.server.common.parse;

import com.syscom.fep.frmcommon.gui.AbstractFrame;
import com.syscom.fep.frmcommon.gui.AbstractPanel;
import com.syscom.fep.frmcommon.gui.GuiProperties;
import com.syscom.fep.frmcommon.gui.util.GuiUtil;
import com.syscom.fep.frmcommon.util.ReflectUtil;
import com.syscom.fep.frmcommon.util.StringUtil;
import com.syscom.fep.server.common.ServerCommonBaseTest;
import com.syscom.fep.vo.text.atm.ATMTextBase;
import com.syscom.fep.vo.text.atm.request.IWDRequest;
import com.syscom.fep.vo.text.atm.response.IFTResponse;
import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.StringUtils;
import org.junit.jupiter.api.Test;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.lang.reflect.Field;

import static org.junit.jupiter.api.Assertions.assertEquals;

public class ATMTextParserTest extends ServerCommonBaseTest {
	static {
		System.setProperty("java.awt.headless", "false");
	}

	private final String message =
			"0F0F0F000674013032360F0F202049574441303031303033313530333936373031323030303030303030303032303131303033313936303131303033313830303035313434333030393030353035303031303031353630303030303530353030313030313536303030303030303030303030303030303030303030303D3F35323F3F383F3D383F38373C3E31393030303039303035303530303130303135363030303D313538393031303030303030303030303030303030343030303030303030303030303030303030313D3030303030303030303030303D3030303030303030303030303D303D303332313730303038343233303030303130303030303030303130302020202020202020202020202020202020202020203030303030303030202020202020202020202020202030303030303030303032323032393136323230323130333138313732383337303035303530303130303135363030303530353030313030313536303030303130463232323434343636363131303030303032333532343C343F3338353F383F37373637323A3030303030303030303130303331383030303020202020203030303139313030333138323136373634313E3030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030302020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202032323220";

	@Test
	public void testParse() throws Exception {
		IWDRequest expected = new IWDRequest();
		expected.setTXCD("495744");
		IWDRequest actual = (IWDRequest) ATMTextParser.getInstance().parse(message.substring(24));
		assertEquals(expected.getTXCD(), actual.getTXCD());
	}

	@Test
	public void testParseIFTResponse() throws Exception {
		String message =
				"0F0F0F000760013030310F0F4946543031313031313233313335393530303030303031303131303131323336303131303035323630303030383439312020202030303036393832303030303030303030303038303730303131313030343030333731343435303031313130303430303337313434353030363030303939393838373231323036333130303030303131303030303030303030303030302B303030303032313637373630302B30303030303231363737363030203030303030303030303030303020303030303030303030303030302039303038303730303030303030303030303030303D313538393031303030303030303030303030303030343030303030303030303030303030303030353D303030303030303030303030303030303D30303030303030303030303030303D303D30303030303030302031303035323620202020202020203030303536383520202020202020202020202020202020303030303030303030303030303030303030303030303030545744545744202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020";

		message =
				"0F0F0F000760013030310F0F4946543031313031313233313530313439303030303031303131303131323336303131303035323630303030383439332020202030303036393838303030303030303030303038303730303131313030343030333731343435303031313130303430303337313434353030363030303939393838373231323036333130303030303131303030303030303030303030302B303030303032313637373630302B30303030303231363737363030203030303030303030303030303020303030303030303030303030302039303038303730303030303030303030303030303D313538393031303030303030303030303030303030343030303030303030303030303030303030353D303030303030303030303030303030303D30303030303030303030303030303D303D30303030303030302031303035323620202020202020203030303536383720202020202020202020202020202020303030303030303030303030303030303030303030303030545744545744202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020";

		IFTResponse resp = new IFTResponse();
		resp.parseFlatfile(message.substring(24));

	}

	@Test
	public void testATMTextParse() throws InterruptedException {
		new AtmTextParseFrame("ATM Text Parse Frame").showFrame();
		while (true) {
			Thread.sleep(24 * 60 * 60 * 60 * 1000);
		}
	}

	private static class AtmTextParseFrame extends AbstractFrame {
		private static final long serialVersionUID = 1L;

		public AtmTextParseFrame(String title) {
			super(title);
		}

		@Override
		protected Component guiLayout() {
			AtmTextParsePanel jmsPanel = new AtmTextParsePanel();
			return jmsPanel;
		}

		@Override
		protected JMenuBar createMenuBar() {
			return null;
		}
	}

	private static class AtmTextParsePanel extends AbstractPanel {
		private static final long serialVersionUID = 1L;

		private JButton parseBtn;
		private JTextArea messageInputArea, messageParsedArea;

		@Override
		protected void initComponents() {
			ActionLster listener = new ActionLster();
			parseBtn = GuiUtil.createButton("拆解", listener);
			messageInputArea = GuiUtil.createTextArea(
					"0F0F0F000684013036330F0F20204551434130303036303832353030313635303232323033303030303030303130313037303430333630313037303432303030303537353937363739393937383930303030303032303033323637393939373839303030303030323031333E3F3937383630313E3C3037353B363739393937383930303030303032303033323D32353132323031303930333830373632202A30302020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202030373034323037363D3034383E3032393031202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202032323220",
					null, true);
			messageInputArea.setRows(5);
			messageParsedArea = GuiUtil.createTextArea(StringUtils.EMPTY, null, false);
		}

		@Override
		protected Component guiLayout() {
			JPanel contentPane = GuiUtil.createPanel(new GridBagLayout());
			contentPane.setBorder(GuiUtil.createLineBorder(GuiProperties.CLR_BORDER));

			contentPane.add(GuiUtil.createLabel("Input Message"), new GridBagConstraints(0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.EAST, GridBagConstraints.NONE,
					GuiUtil.createInsets(GuiProperties.GAP, GuiProperties.GAP, GuiProperties.GAP, GuiProperties.GAP), 0, 0));
			contentPane.add(new JScrollPane(messageInputArea), new GridBagConstraints(1, 0, 1, 1, 1.0, 0.0, GridBagConstraints.CENTER, GridBagConstraints.BOTH,
					GuiUtil.createInsets(GuiProperties.GAP, 0, GuiProperties.GAP, GuiProperties.GAP), 0, 0));

			contentPane.add(GuiUtil.createLabel("Parse Result"), new GridBagConstraints(0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.EAST, GridBagConstraints.NONE,
					GuiUtil.createInsets(0, GuiProperties.GAP, GuiProperties.GAP, GuiProperties.GAP), 0, 0));
			contentPane.add(new JScrollPane(messageParsedArea), new GridBagConstraints(1, 1, 1, 1, 1.0, 1.0, GridBagConstraints.CENTER, GridBagConstraints.BOTH,
					GuiUtil.createInsets(0, 0, GuiProperties.GAP, GuiProperties.GAP), 0, 0));

			JPanel btnPane = GuiUtil.createPanel(new FlowLayout(FlowLayout.RIGHT, GuiProperties.GAP, 0));
			btnPane.add(parseBtn);
			contentPane.add(btnPane, new GridBagConstraints(0, 2, 2, 1, 1.0, 0.0, GridBagConstraints.CENTER, GridBagConstraints.HORIZONTAL,
					GuiUtil.createInsets(0, GuiProperties.GAP, GuiProperties.GAP, GuiProperties.GAP), 0, 0));
			return contentPane;
		}

		final class ActionLster implements ActionListener {

			@Override
			public void actionPerformed(ActionEvent e) {
				if (parseBtn.equals(e.getSource())) {
					String message = messageInputArea.getText();
					if (StringUtils.isBlank((String) message)) {
						String errorMessage = "請輸入訊息";
						showErrorMessage(errorMessage);
						GuiUtil.showErrorMessage(AtmTextParsePanel.this, "錯誤", errorMessage);
						messageInputArea.requestFocus();
						return;
					}
					StringBuilder sb = new StringBuilder();
					try {
						ATMTextBase atmBase = ATMTextParser.getInstance().parse(message.substring(24));
						sb.append(atmBase.getClass().getName()).append(":\r\n");
						Field[] fields = atmBase.getClass().getDeclaredFields();
						if (ArrayUtils.isNotEmpty(fields)) {
							for (Field field : fields) {
								Object value = ReflectUtil.getFieldValue(atmBase, field, null);
								if (value instanceof String)
									sb.append(field.getName()).append("[ascii value] = ").append(value == null ? "[NO DATA]" : StringUtils.join(value, "[", StringUtil.fromHex((String) value), "]"))
											.append("\r\n");
								else
									sb.append(field.getName()).append("=").append(value == null ? "[NO DATA]" : value);
							}
						}
					} catch (Exception ex) {
						GuiUtil.showErrorMessage(AtmTextParsePanel.this, "錯誤", ex.getMessage());
					} finally {
						messageParsedArea.setText(sb.toString());
					}
				}
			}
		}
	}
}
